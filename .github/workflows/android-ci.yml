name: Step Counter App CI/CD

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  # Build and Test Android App
  build-and-test:
    name: Build & Test Android App
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle
        
    - name: Grant Execute Permission for Gradlew
      run: chmod +x gradlew
      
    - name: Validate Gradle Wrapper
      uses: gradle/wrapper-validation-action@v2
        
    - name: Build with Gradle
      run: ./gradlew build --stacktrace
      
    - name: Run Unit Tests
      run: ./gradlew test --stacktrace
      
    - name: Generate Test Report
      if: always()
      run: |
        echo "ğŸ“Š Test Results:"
        if [ -d "app/build/reports/tests/testDebugUnitTest" ]; then
          echo "âœ… Unit tests completed"
        else
          echo "âš ï¸ No test results found"
        fi
        
    - name: Upload Test Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-reports
        path: app/build/reports/tests/
        retention-days: 7
        
  # Lint Check
  lint-check:
    name: Android Lint Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle
        
    - name: Grant Execute Permission for Gradlew
      run: chmod +x gradlew
      
    - name: Run Lint
      run: ./gradlew lintDebug --stacktrace
      
    - name: Upload Lint Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: lint-reports
        path: app/build/reports/lint-results-*.html
        retention-days: 7
        
  # APK Build
  apk-build:
    name: Build Debug APK
    runs-on: ubuntu-latest
    needs: [build-and-test, lint-check]
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle
        
    - name: Grant Execute Permission for Gradlew
      run: chmod +x gradlew
      
    - name: Build Debug APK
      run: ./gradlew assembleDebug --stacktrace
      
    - name: Verify APK
      run: |
        if [ -f "app/build/outputs/apk/debug/app-debug.apk" ]; then
          echo "âœ… APK built successfully"
          ls -lh app/build/outputs/apk/debug/app-debug.apk
        else
          echo "âŒ APK not found"
          exit 1
        fi
        
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: step-counter-debug-apk
        path: app/build/outputs/apk/debug/app-debug.apk
        retention-days: 14
        
  # Validate Project Structure
  validate-structure:
    name: Validate Project Structure
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
    
    - name: Check Required Files
      run: |
        echo "ğŸ” Checking project structure..."
        
        files=(
          "build.gradle.kts"
          "settings.gradle.kts"
          "gradlew"
          "app/build.gradle.kts"
          "app/src/main/AndroidManifest.xml"
          "app/src/main/java/com/example/stepcounterapp/MainActivity.java"
        )
        
        missing=0
        for file in "${files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "âŒ Missing: $file"
            missing=$((missing + 1))
          else
            echo "âœ… Found: $file"
          fi
        done
        
        if [ $missing -gt 0 ]; then
          echo "âŒ $missing required file(s) missing"
          exit 1
        fi
        
        echo "âœ… All required files present"
        
    - name: Check Test Files
      run: |
        echo "ğŸ§ª Checking test files..."
        
        test_files=(
          "app/src/test/java/com/example/stepcounterapp/StepCalculationsTest.java"
          "app/src/test/java/com/example/stepcounterapp/StepSessionTest.java"
          "app/src/test/java/com/example/stepcounterapp/ConvertersTest.java"
        )
        
        for file in "${test_files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… Found: $file"
          else
            echo "âš ï¸ Missing: $file"
          fi
        done
        
  # Build Summary
  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [build-and-test, lint-check, apk-build, validate-structure]
    if: always()
    
    steps:
    - name: All Checks Status
      run: |
        echo "ğŸ‰ Step Counter App CI/CD Pipeline Complete!"
        echo ""
        echo "âœ… Build & Test: Completed"
        echo "âœ… Lint Check: Completed"
        echo "âœ… APK Build: Completed"
        echo "âœ… Structure Validation: Completed"
        echo ""
        echo "ğŸ“± Your Step Counter App is ready!"
        echo "ğŸš€ Debug APK available in artifacts"
